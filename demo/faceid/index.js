/*
  Human
  homepage: <https://github.com/vladmandic/human>
  author: <https://github.com/vladmandic>'
*/

var Q=Object.defineProperty;var J=(a,e,t)=>e in a?Q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var R=(a,e,t)=>J(a,typeof e!="symbol"?e+"":e,t);import*as U from"../../dist/human.esm.js";var v,Z="human",y="person",F=(...a)=>console.log("indexdb",...a);async function C(){return v?!0:new Promise(a=>{let e=indexedDB.open(Z,1);e.onerror=t=>F("error:",t),e.onupgradeneeded=t=>{F("create:",t.target),v=t.target.result,v.createObjectStore(y,{keyPath:"id",autoIncrement:!0})},e.onsuccess=t=>{v=t.target.result,F("open:",v),a(!0)}})}async function q(){let a=[];return v||await C(),new Promise(e=>{let t=v.transaction([y],"readwrite").objectStore(y).openCursor(null,"next");t.onerror=o=>F("load error:",o),t.onsuccess=o=>{o.target.result?(a.push(o.target.result.value),o.target.result.continue()):e(a)}})}async function E(a){v||await C();let e={name:a.name,descriptor:a.descriptor,image:a.image};v.transaction([y],"readwrite").objectStore(y).put(e),F("save:",e)}async function j(a){v||await C(),v.transaction([y],"readwrite").objectStore(y).delete(a.id),F("delete:",a)}var H=class{constructor(e,t,o,d){this.knownDescriptors=e;this.knownFaces=t;this.matchOptions=o;this.human=d;R(this,"trackedFaces",new Map);R(this,"trackingThreshold",5e3);R(this,"similarityThreshold",.6);R(this,"autoSaveEnabled",!0)}updateKnownFaces(e,t){this.knownDescriptors=e,this.knownFaces=t}generateFaceId(e){if(!e.box)return Math.random().toString();let[t,o,d,u]=e.box;return`${Math.round(t)}_${Math.round(o)}_${Math.round(d)}_${Math.round(u)}`}isSameFace(e,t){if(!e.box||!t.box)return!1;let[o,d,u,r]=e.box,[l,h,s,i]=t.box,c=50,m=30;return Math.abs(o-l)<c&&Math.abs(d-h)<c&&Math.abs(u-s)<m&&Math.abs(r-i)<m}findMatchingKnownFace(e){if(!e.embedding||e.embedding.length===0||this.knownDescriptors.length===0)return null;let t=this.human.match.find(e.embedding,this.knownDescriptors,this.matchOptions),o=this.knownFaces[t.index];return o&&t.similarity>this.similarityThreshold?{record:o,similarity:t.similarity}:null}async processFaces(e){let t=Date.now(),o=new Set,d=[],u=[];for(let r of e){if(!r.embedding||r.embedding.length===0)continue;let l=this.findMatchingKnownFace(r),h=l!==null,s=null;for(let[i,c]of this.trackedFaces)if(this.isSameFace(r,c.face)){s=c,o.add(i);break}if(s)s.face=r,s.lastSeen=t,s.trackingDuration=t-s.firstSeen,s.isMatched=h,s.matchedRecord=l==null?void 0:l.record;else{let i=this.generateFaceId(r);s={id:i,face:r,firstSeen:t,lastSeen:t,trackingDuration:0,isMatched:h,matchedRecord:l==null?void 0:l.record},this.trackedFaces.set(i,s),o.add(i)}!s.isMatched&&s.trackingDuration>=this.trackingThreshold&&this.autoSaveEnabled&&(await this.autoRegisterFace(s),d.push(s)),u.push(s)}for(let[r,l]of this.trackedFaces)o.has(r)||t-l.lastSeen>2e3&&this.trackedFaces.delete(r);return{newlyRegistered:d,updates:u}}async autoRegisterFace(e){try{let o=`Unknown_${new Date().toLocaleString("ko-KR")}`,d=this.getFaceCropImageData(e.face),u={id:0,name:o,descriptor:e.face.embedding,image:d};await E(u),e.isMatched=!0,console.log("Auto-registered face:",o)}catch(t){console.error("Failed to auto-register face:",t)}}getFaceCropImageData(e){if(!e.box){let x=document.createElement("canvas");return x.width=x.height=128,x.getContext("2d").getImageData(0,0,128,128)}let t=document.getElementById("video"),[o,d,u,r]=e.box,l=Math.max(0,Math.floor(o)),h=Math.max(0,Math.floor(d)),s=Math.max(1,Math.min(t.videoWidth-l,Math.floor(u))),i=Math.max(1,Math.min(t.videoHeight-h,Math.floor(r))),c=document.createElement("canvas");c.width=c.height=128;let m=c.getContext("2d");return m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.drawImage(t,l,h,s,i,0,0,128,128),m.getImageData(0,0,128,128)}getTrackedFaces(){return Array.from(this.trackedFaces.values())}getTrackingInfo(e){return this.trackedFaces.get(e)||null}};var L={cacheSensitivity:.01,modelBasePath:"../../models",filter:{enabled:!0,equalization:!0},backend:"humangl",debug:!0,face:{enabled:!0,detector:{maxDetected:3,rotation:!0,return:!1,mask:!1},description:{enabled:!0},iris:{enabled:!1},emotion:{enabled:!1}},body:{enabled:!1},hand:{enabled:!1},object:{enabled:!1}},_={order:2,multiplier:20,min:.1,max:.9},K,z,A,V,G={minConfidence:.6,minSize:224,maxTime:3e4,blinkMin:10,blinkMax:800,threshold:.5,distanceMin:.4,distanceMax:1,mask:(z=(K=L.face)==null?void 0:K.detector)==null?void 0:z.mask,rotation:(V=(A=L.face)==null?void 0:A.detector)==null?void 0:V.rotation,..._},T={face:null,record:null},D=[],O=[],S,f=new U.Human(L);f.env.perfadd=!1;f.draw.options.font='small-caps 18px "Lato"';f.draw.options.lineHeight=20;var n={video:document.getElementById("video"),canvas:document.getElementById("canvas"),log:document.getElementById("log"),fps:document.getElementById("fps"),match:document.getElementById("match"),matches:document.getElementById("matches"),name:document.getElementById("name"),save:document.getElementById("save"),delete:document.getElementById("delete"),source:document.getElementById("source")},X={detect:0,draw:0};var b=(...a)=>{n.log.innerText+=a.join(" ")+`
`,console.log(...a)};function Y(a,e,t=128){let[o,d,u,r]=e,l=Math.max(0,Math.floor(o)),h=Math.max(0,Math.floor(d)),s=Math.max(1,Math.min(a.videoWidth-l,Math.floor(u))),i=Math.max(1,Math.min(a.videoHeight-h,Math.floor(r))),c=document.createElement("canvas");c.width=t,c.height=t;let m=c.getContext("2d");return m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.drawImage(a,l,h,s,i,0,0,t,t),m.getImageData(0,0,t,t)}async function ee(){let a={audio:!1,video:{facingMode:"user",resizeMode:"none",width:{ideal:document.body.clientWidth}}},e=await navigator.mediaDevices.getUserMedia(a),t=new Promise(d=>{n.video.onloadeddata=()=>d(!0)});n.video.srcObject=e,n.video.play(),await t,n.canvas.width=n.video.videoWidth,n.canvas.height=n.video.videoHeight;let o=document.getElementById("stage");if(o){let d=()=>{n.canvas.style.transform="translateZ(0)"};new ResizeObserver(d).observe(o),d()}f.env.initial&&b("video:",n.video.videoWidth,n.video.videoHeight,"|",e.getVideoTracks()[0].label),n.canvas.onclick=()=>{n.video.paused?n.video.play():n.video.pause()}}async function N(){var i;if(n.video.paused)return;await f.detect(n.video);let a=f.next(f.result),e=n.canvas.getContext("2d");e==null||e.clearRect(0,0,n.canvas.width,n.canvas.height);let t=a.face.slice(0,3),{newlyRegistered:o,updates:d}=await S.processFaces(t);if(o.length>0){await B(),S.updateKnownFaces(O,D);for(let c of o)b("\uC790\uB3D9 \uB4F1\uB85D\uB428:",((i=c.matchedRecord)==null?void 0:i.name)||"Unknown")}let u=[],r=[],l=S.getTrackedFaces();e&&(e.save(),e.font="16px Lato",e.fillStyle="white",e.strokeStyle="black",e.lineWidth=2);let h=null;for(let c=0;c<t.length;c+=1){let m=t[c],x="unknown",M=null,g=l.find(p=>p.face.box&&m.box&&Math.abs(p.face.box[0]-m.box[0])<50&&Math.abs(p.face.box[1]-m.box[1])<50);if(g)if(g.isMatched&&g.matchedRecord)M=g.matchedRecord,x=`${g.matchedRecord.name}`,h||(h={name:g.matchedRecord.name,similarity:1,record:g.matchedRecord});else{let p=Math.min(g.trackingDuration/5e3,1),w=Math.max(0,5e3-g.trackingDuration);x=`\uCD94\uC801\uC911 ${(p*100).toFixed(0)}% (${(w/1e3).toFixed(1)}s)`}if(e&&m.box){let[p,w,k,I]=m.box;if(g!=null&&g.isMatched)e.strokeStyle="lime";else if(g){let P=Math.min(g.trackingDuration/5e3,1);e.strokeStyle=`rgb(${255-Math.round(P*255)}, ${Math.round(P*255)}, 0)`}else e.strokeStyle="red";e.strokeRect(p,w,k,I);let $=Math.max(0,w-6);e.strokeStyle="black",e.strokeText(x,p,$),e.fillText(x,p,$)}u.push(x),r.push(M)}T.face=t.sort((c,m)=>m.box[2]*m.box[3]-c.box[2]*c.box[3])[0]||null,T.record=h?h.record:null,te(t,u,r,l);let s=f.now();X.detect=s,requestAnimationFrame(N)}function te(a,e,t,o){if(n.matches){if(n.matches.innerHTML="",a.length===0){n.matches.innerText="no faces detected";return}a.forEach((d,u)=>{let r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.margin="4px 0";let l=document.createElement("div");l.innerText=`face ${u+1}: ${e[u]||"unknown"}`,r.appendChild(l);let h=o.find(i=>i.face.box&&d.box&&Math.abs(i.face.box[0]-d.box[0])<50&&Math.abs(i.face.box[1]-d.box[1])<50);if(h&&!h.isMatched){let i=document.createElement("div");i.style.fontSize="12px",i.style.color="#888";let c=Math.max(0,5e3-h.trackingDuration);i.innerText=`(${(c/1e3).toFixed(1)}\uCD08 \uD6C4 \uC790\uB3D9 \uB4F1\uB85D)`,r.appendChild(i)}if(d.box&&n.video.videoWidth>0){let[i,c,m,x]=d.box,M=Math.max(0,Math.floor(i)),g=Math.max(0,Math.floor(c)),p=Math.min(n.video.videoWidth-M,Math.floor(m)),w=Math.min(n.video.videoHeight-g,Math.floor(x)),k=document.createElement("canvas");k.width=96,k.height=96;let I=k.getContext("2d");I&&p>0&&w>0&&I.drawImage(n.video,M,g,p,w,0,0,96,96),r.appendChild(k)}let s=t[u];if(s!=null&&s.image){let i=document.createElement("canvas");i.width=s.image.width,i.height=s.image.height,i.style.width="96px",i.style.height="96px";let c=i.getContext("2d");c==null||c.putImageData(s.image,0,0),r.appendChild(i)}n.matches.appendChild(r)})}}async function ae(){var a;if(n.name.value.length>0){let t=f.result.face.sort((u,r)=>r.box[2]*r.box[3]-u.box[2]*u.box[3])[0];if(!(t!=null&&t.embedding)){b("no face embedding to save");return}let o=Y(n.video,t.box,128),d={id:0,name:n.name.value,descriptor:t.embedding,image:o};await E(d),await B(),b("saved face record:",d.name,"descriptor length:",((a=t.embedding)==null?void 0:a.length)||0),b("known face records:",D.length)}else b("invalid name")}async function ne(){T.record&&T.record.id>0&&(await j(T.record),await B())}async function oe(){n.match.style.display="flex",n.save.style.display="flex",n.delete.style.display="flex",n.source.style.display="none",n.canvas.style.height="",document.body.style.background="black",n.video.paused&&n.video.play(),await N()}async function re(){b("human version:",f.version,"| tfjs version:",f.tf.version["tfjs-core"]),b("options:",JSON.stringify(G).replace(/{|}|"|\[|\]/g,"").replace(/,/g," ")),b("initializing webcam..."),await ee(),b("loading human models..."),await f.load(),b("initializing human..."),b("loading face database..."),await B(),S=new H(O,D,_,f),b("face tracker initialized"),n.save.addEventListener("click",ae),n.delete.addEventListener("click",ne),await f.warmup(),await oe()}window.onload=re;async function B(){D=await q(),O=D.map(a=>a.descriptor).filter(a=>a.length>0),b("known face records:",D.length)}
//# sourceMappingURL=index.js.map
